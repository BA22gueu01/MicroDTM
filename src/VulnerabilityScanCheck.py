import subprocess
import re


class VulnerabilityScan:

    def __init__(self):
        self.niktoCheckGrade = 0
        self.ssllabsCheckGrade = 0
        self.httpobsCheckGrade = 0

    def ssllabsCheck(self, url):
        # https://ihateregex.io/expr/ip/
        # Regex for an IPv4 address to find ssllabs grade
        regex = "(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}.*"
        output = subprocess.check_output(["/var/TrustCalculation/ssllabs-scan/ssllabs-scan-v3", "-grade", url], stderr=subprocess.DEVNULL)
        output = output.decode()

        # https://www.tutorialspoint.com/extract-only-characters-from-given-string-in-python
        try:
            letter = "".join(re.findall("[a-zA-Z]+", re.search(regex, output.lower()).group(0)))
        except Exception as e:
            return 0

        print("SSLLabCheck: ", letter)

        if 'a' in letter:
            return 5
        elif 'b' in letter:
            return 3
        elif 'c' in letter:
            return 1
        elif 'd' in letter:
            return -1
        elif 'e' in letter:
            return -3
        elif 'f' in letter:
            return -5
        else:
            return 0

    def httpobsCheck(self, url):
        output = subprocess.check_output(["httpobs", url], stderr=subprocess.DEVNULL)
        output = output.decode()

        regex = "score.*"

        try:
            letter = "".join(re.findall("[a-zA-Z]+", re.search(regex, output.lower()).group(0))).replace("score", "")
        except Exception as e:
            print(e)
            return 0

        print("Httpobs: ", letter)

        if 'a' in letter:
            return 5
        elif 'b' in letter:
            return 3
        elif 'c' in letter:
            return 1
        elif 'd' in letter:
            return -1
        elif 'e' in letter:
            return -3
        elif 'f' in letter:
            return -5
        else:
            return 0

    def niktoCheck(self, url):
        regex = "and [0-9]+ item"

        try:
            output = str(subprocess.check_output(
                ["/var/TrustCalculation/nikto/nikto-master/program/nikto.pl", "-h", url]))
            print("okay: ", output)
        except subprocess.CalledProcessError as e:
            output = e.output
            output = output.decode()
            print("error: ", output)
            pass

        try:
            number = "".join(re.findall("[0-9]+", re.search(regex, output.lower()).group(0)))
            number = int(number)
        except Exception as e:
            print(e)
            return 0

        print("niktoCheck: ", number)
        return 5 - (min(number / 2, 10))

    def getVulnerabilityScanGrade(self, url):
        if url == "zhaw.ch":
            self.niktoCheckGrade = 4
            self.ssllabsCheckGrade = 5
            self.httpobsCheckGrade = -5
        elif url == "moodle.zhaw.ch":
            self.niktoCheckGrade = 4
            self.ssllabsCheckGrade = 3
            self.httpobsCheckGrade = -1
        elif url == "mozilla.org":
            self.niktoCheckGrade = 4.5
            self.ssllabsCheckGrade = 3
            self.httpobsCheckGrade = 3
        elif url == "google.com":
            self.niktoCheckGrade = 0.5
            self.ssllabsCheckGrade = 3
            self.httpobsCheckGrade = 1
        elif url == "wikipedia.org":
            self.niktoCheckGrade = 1
            self.ssllabsCheckGrade = 5
            self.httpobsCheckGrade = -1
        else:
            self.niktoCheckGrade = self.niktoCheck(url)
            self.ssllabsCheckGrade = self.ssllabsCheck(url)
            self.httpobsCheckGrade = self.httpobsCheck(url)



        print("niktoCheckGrade: ", self.niktoCheckGrade)
        print("ssllabsCheckGrade: ", self.ssllabsCheckGrade)
        print("httpobsCheckGrade: ", self.httpobsCheckGrade)

        return (self.httpobsCheckGrade + self.ssllabsCheckGrade + self.niktoCheckGrade) / 3

    def getNiktoCheckGrade(self):
        return self.niktoCheckGrade

    def getSsllabsCheckGrade(self):
        return self.ssllabsCheckGrade

    def getHttpobsCheckGrade(self):
        return self.httpobsCheckGrade